# 道威管理系统（Daowei）— 项目介绍（无代码版）

> 本文档用于快速理解仓库结构、技术栈、运行/部署方式与关键机制（鉴权、限流、实时同步、日志、文件与图片、第三方代理、DDNS等）。
> 
> 说明：本文刻意**不包含任何源码片段**；涉及密钥/口令的地方仅给出“字段名/配置点”和安全建议。

---

## 1. 项目定位与核心目标

道威管理系统是一套面向小团队内部使用的企业管理系统，提供：

- **PC 端管理后台**（Element Plus UI）
- **移动端 H5/APP**（Vant UI；APP 使用 Capacitor WebView 封装）
- **后端 REST API**（Spring Boot + MyBatis）
- **PostgreSQL 数据库**
- **SSE 实时同步**（多用户同时操作时，订单/样品数据可实时同步，无需刷新页面）

适用场景：小企业内部管理系统（并发规模不大）。

---

## 2. 仓库总览

仓库根目录主要包含：

- `daowei_vue3/`：前端（PC + 移动端双端同仓）
- `daowei_springboot/`：后端（REST API + SSE + 鉴权/限流/日志等）
- `daowei_capacitor/`：移动端 APP 封装工程（Capacitor Android）
- `db_backup_tool/`：数据库备份/同步到本地的小工具（Java 命令行）
- `DEPLOY_QUICK.md`：快速部署说明（偏运维侧）
- `OPTIMIZATION_ROADMAP.md`：优化路线图与已完成功能记录

---

## 3. 技术栈与关键依赖

### 3.1 前端（`daowei_vue3`）

- 框架：Vue 3（Composition API）
- 构建：Vite
- 路由：Vue Router
- 状态管理：Pinia
- UI：
  - PC：Element Plus
  - 移动：Vant
- 网络请求：Axios（统一封装）
- 常用工具：dayjs、xlsx、jszip、html2canvas、拼音搜索等

### 3.2 后端（`daowei_springboot`）

- Spring Boot：2.7.x
- Java：项目编译目标为 **Java 17**（请以 `pom.xml` 为准）
- ORM：MyBatis + XML Mapper
- 鉴权：JWT（支持 tokenVersion 做“单点登录/踢下线”）
- 限流：基于 IP 的简单限流过滤器
- 实时推送：SSE（Server-Sent Events）
- 操作日志：AOP 注解方式自动记录（含更新前后数据对比）

### 3.3 数据库

- PostgreSQL
- 初始化脚本：`daowei_springboot/postgresql/daowei.sql`

### 3.4 移动端 APP（`daowei_capacitor`）

- Capacitor（Android）
- 本质：**WebView 加载线上地址**（服务器更新后，APP 端无需重新发版即可获取最新前端）

### 3.5 数据库备份工具（`db_backup_tool`）

- Java 命令行工具
- 依赖 PostgreSQL 客户端工具（pg_dump/psql/dropdb/createdb）

---

## 4. 前端结构与双端机制（PC / 移动）

`daowei_vue3/src/` 主要分为：

- `pc/`：PC 端页面与组件
- `mp/`：移动端页面与组件
- `core/`：双端共享核心（API 封装、请求拦截、认证工具、SSE、心跳、草稿、偏好等）
- `stores/`：Pinia 状态（如统一认证 store）
- `config/`：环境与服务端地址拼装

### 4.1 多入口页面

构建输出包含多入口：

- PC 入口页
- 移动端入口页
- 主入口页（根据设备/路径做跳转）

### 4.2 环境变量与后端地址

前端通过环境变量组装后端地址：

- 后端主机/端口
- API Base Path

原则：

- 开发环境可使用完整后端地址
- 生产环境通常走相对路径，由 Nginx 反向代理到后端

### 4.3 统一请求封装（Axios）

核心点：

- 统一添加 `Authorization: Bearer <token>`
- 统一错误码处理（含 401、以及自定义 4011/4012 等）
- 认证失效时自动清理本地认证信息并跳转登录页

### 4.4 路由守卫与 token 过期预判

- 路由 meta 标记需要认证的页面
- 客户端解析 JWT 的 exp 字段，**提前 5 分钟**视为即将过期并引导重新登录

### 4.5 心跳检测（前端定时）

- 前端每 1 分钟检测一次 token 即将过期情况
- 即将过期只提示一次；过期后跳转登录

---

## 5. 后端结构与核心能力

后端入口：`com.example.demo.Application`（启用异步、启用定时任务）。

后端典型分层：

- Controller：对外 REST API
- Service：业务逻辑
- Mapper：MyBatis 数据访问
- Entity/DTO：实体与传输对象
- Config/Filter：跨域、鉴权过滤器、限流等
- Aspect/Annotation：操作日志 AOP

---

## 6. 鉴权（JWT）与账号互踢（tokenVersion）

### 6.1 JWT 内容

JWT 内含：

- 用户 id
- username
- role（admin / user）
- tokenVersion（用于单点登录）

### 6.2 认证过滤器（后端）

- 对 `/api/*` 进行 JWT 校验
- 放行：登录接口、token 校验接口、以及部分图片/静态资源路径
- 校验成功后，会把 userId/username/name/role 写入 request attribute，供后续日志切面等使用

补充说明：

- SSE 订阅接口也位于 `/api` 下，如果后端对其启用 JWT 校验，前端的 `EventSource` **无法自定义请求头**，因此需要后端“放行 SSE 订阅接口”或改用 Cookie 鉴权/在查询参数中携带 token 并在后端自行校验（两端需要配套实现）。

### 6.3 自定义错误码（前后端联动）

- **4011**：tokenVersion 不匹配（账号在其他设备登录，当前会话被踢下线）
- **4012**：用户不存在或已被删除

（前端已对以上错误码做统一提示与跳转处理）

---

## 7. 限流（RateLimit）

后端在 `/api/*` 上启用基于 IP 的简单限流：

- 普通接口：按时间窗口限制请求数
- 登录接口：更严格的限制

用途：减少暴力登录、误操作/脚本带来的压力。

---

## 8. 实时同步（SSE）机制

### 8.1 连接方式

前端使用 `EventSource` 连接后端 SSE 订阅接口。

- 连接成功后会收到 `connect` 事件（用于确认已建立连接）
- 连接异常时会自动重连（延迟一段时间后重试）

鉴权注意：

- `EventSource` 天生无法像 Axios 一样附加自定义 Header。
- 如果你开启了后端对 `/api/notifications/subscribe` 的 JWT 校验，最常见的处理方式是：
  - **后端放行该订阅接口**（但要评估风险），或
  - 改为基于 Cookie 的会话鉴权（浏览器会自动携带），或
  - 通过 query 参数携带 token 并在后端进行校验（需要双方统一约定）。

### 8.2 事件类型与前端行为

目前用于业务同步的事件类型包括：

- `order_sync`
  - 前端触发浏览器自定义事件 `order-sync`
  - 订单管理页面监听该事件后刷新列表/详情
  - 若状态变更，会形成一条“状态变更通知”；否则为普通“数据更新通知”

- `sample_sync`
  - 前端触发浏览器自定义事件 `sample-sync`
  - 样品管理页面监听该事件后刷新数据

### 8.3 触发范围（以现有实现为准）

- 订单：目前在“更新订单”接口中触发 `order_sync`
- 样品：目前在“更新样品”接口中触发 `sample_sync`

注意：当前实现**未在创建/删除时广播同步事件**（如果你希望创建/删除也同步，需要额外开发与联调）。

---

## 9. 操作日志（AOP 注解）

### 9.1 写入方式

- Controller 方法上通过注解标记“模块、动作、描述、实体类型、ID 参数位置”等
- AOP 环绕通知在方法执行前后采集：
  - 操作人（来自 JWT Filter 注入的 request attribute）
  - 请求 URL/Method/IP/User-Agent
  - 请求参数（会过滤不可序列化对象，如 MultipartFile）
  - UPDATE/DELETE 的“修改前数据”（按实体类型与 id 查询）
  - UPDATE 的“新数据”（从入参中挑选实体对象序列化）
  - 响应数据（截断保存）
  - 执行耗时与异常信息

### 9.2 作用

- 支撑审计与问题追踪
- 支撑“谁在什么时候改了什么”的追溯

---

## 10. 文件上传与图片访问

### 10.1 上传

- 样品创建/更新支持上传图片（multipart/form-data）
- 后端保存到服务器文件目录
- 保存后返回图片访问路径（对外以 URL 路径表现）

### 10.2 图片访问路径

- 图片访问入口为 `/sampleImage/...`
- 支持缩略图：`/sampleImage/thumb/...`（可指定尺寸）

路径一致性提示：

- 后端图片 Controller 对外路径为 `/sampleImage`。
- 但后端 JWT 过滤器的“放行路径”中存在 `/sample/`（与 `/sampleImage` 不同）的配置，这可能是历史遗留或命名未统一。
- 如果你遇到图片 401/403 或访问异常，建议优先统一：
  - 前端/反代使用的图片前缀
  - 后端过滤器的放行前缀

部署时常见做法：

- 前端通过 Nginx 反向代理把 `/sampleImage` 转发到后端

---

## 11. 第三方 API 代理（后端统一代理，前端不保存密钥）

系统将部分第三方服务通过后端代理访问：

- 天气
- 日历
- OCR（含 token 缓存）

设计目的：

- 前端不持有第三方密钥，降低泄露风险
- 可在后端统一做缓存、鉴权、限流与日志

---

## 12. DDNS 动态域名更新（后端定时任务）

后端包含 DDNS 更新服务：

- 定时访问 YDNS 更新 URL
- 默认可通过配置项启用/禁用
- 定时频率：以实现为准（当前实现为 fixedRate 方式，约 1 小时一次；类注释中提到的“15 分钟”可能与实际不一致）
- 会把更新结果写入操作日志表（system 角色），并尽量“只保留一份系统日志”（更新而非无限新增）

运维建议：

- 生产环境请将 DDNS URL 放在私密配置中，避免泄露
- 若服务器 IP 固定，可直接关闭该功能

---

## 13. 数据库结构（PostgreSQL）

初始化脚本包含：

- `admin`：管理员
- `user`：普通用户
- `customer` / `customer_address` / `customer_contact`
- `employee`
- `sample`：样品
- `orders`：订单
- `operation_log`：操作日志

关键关系（概念级）：

- sample 关联 customer（可为空）
- orders 关联 sample（外键）
- customer 的地址与联系人使用子表维护
- operation_log 记录操作行为（含请求与变更内容）

数据库脚本同时包含：

- 必要索引
- 更新时间戳触发器（自动更新 update_time）

---

## 14. 运行方式（开发）

### 14.1 前端开发

- 安装依赖后启动 Vite 开发服务器
- 通过 Vite 代理把 `/api` 等请求转发到后端

### 14.2 后端开发

- 需要 Java 与 Maven
- 复制后端配置模板文件，填写数据库连接、JWT、上传目录、第三方 key 等

重要：

- 后端真实配置文件通常会被 `.gitignore` 忽略（避免密钥提交）

---

## 15. 部署方式（典型：Nginx + 后端 JAR + PostgreSQL）

常见部署形态：

- 后端：以 JAR 形式运行，监听后端端口
- 前端：构建产物部署到 Nginx 静态目录
- Nginx：
  - `/api` 反向代理到后端
  - `/sampleImage` 反向代理到后端
  - SPA history 模式配置（未命中的路由回到前端入口）

（更细的运维步骤以根目录 `DEPLOY_QUICK.md` 为准。）

---

## 16. 数据库备份/同步工具（`db_backup_tool`）

用途：

- 从远程 PostgreSQL 导出（pg_dump）
- 清空本地数据库并重新创建
- 导入备份到本地（psql）

风险提示：

- 该工具会**覆盖本地数据库**，仅建议在你明确知道后果的情况下使用
- 建议把远程连接信息与口令改为本地私密配置/环境变量（避免硬编码泄露）

---

## 17. 移动端 APP（Capacitor）

特点：

- APP 只是 WebView 壳，加载线上 URL
- 服务器更新后 APP 自动获取最新页面

打包说明：

- 提供 `build.bat` 一键打包脚本
- 可在脚本/配置中设置：
  - APP 名称、包名
  - 加载的 URL
  - keystore 相关参数

安全建议：

- keystore 与口令属于敏感资产，建议不要提交到公开仓库；在团队内应妥善备份与权限控制

---

## 18. 安全与运维建议（关键）

- **严禁把数据库口令、JWT 密钥、第三方 API 密钥硬编码并提交到仓库**
- 生产环境优先使用：
  - 环境变量
  - 服务器私密配置文件
  - 或配置中心
- Nginx/反代层建议：
  - 为静态资源设置合理缓存
  - 为 API 设置必要的超时与日志
- SSE 长连接：
  - 注意代理层超时设置
  - 客户端断线重连会产生额外请求，应关注连接数与异常日志

---

## 19. 常见问题（FAQ）

- 为什么 APP 不需要重新发版？
  - 因为 APP 加载线上页面（WebView），前端上线即生效。

- 为什么“更新”能实时同步，“创建/删除”不一定同步？
  - 当前 SSE 广播在更新接口里实现，创建/删除未广播；如需全量同步需要补齐广播逻辑并处理前端刷新策略。

- 为什么有两套端口（前端/后端）？
  - 前端是静态站点/开发服务器端口；后端是 API 服务端口，生产环境通常由 Nginx 对外统一入口。
